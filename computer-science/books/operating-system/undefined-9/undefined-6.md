# 복구

파일 시스템의 복구(Recovery)는 시스템 충돌(Crash), 하드웨어 오류 또는 프로그램 오류 등으로 인해 파일 시스템의 일관성이 깨졌을 때, 이를 안전하게 이전 상태로 되돌리거나 수정하는 메커니즘을 의미합니다. 파일 시스템 메타데이터의 일관성 유지가 복구의 핵심 목표입니다.

**1. 일관성 문제의 발생**

파일 시스템의 메타데이터(예: 빈 공간 목록, 디렉터리 엔트리, FCB/inode)는 서로 연결되어 있습니다. 예를 들어, 파일을 생성할 때 운영체제는 다음과 같은 여러 단계를 수행해야 합니다.

* 빈 공간 목록 업데이트: 할당된 블록을 빈 목록에서 제거합니다.
* FCB/inode 생성 및 쓰기: 파일 속성 정보를 디스크에 기록합니다.
* 디렉터리 엔트리 업데이트: 파일 이름과 FCB 주소를 연결하는 엔트리를 디스크에 기록합니다.

만약 이 작업 중 중간 단계에서 시스템 충돌이 발생하면, 디스크에 기록된 정보가 불완전해져 파일 시스템의 일관성이 깨집니다.

* 예시: 빈 공간 목록에서는 블록이 할당되었다고 표시되었으나, 디렉터리 엔트리에는 파일 이름이 기록되지 않은 경우 (-> 누수된 공간(Lost Space) 발생).

**2. 일관성 검사 및 복구 (Consistency Checking)**

과거의 파일 시스템은 복구 시 \*\*일관성 검사 도구(Consistency Checker, 예: Unix의 `fsck`)\*\*를 사용하여 일관성을 복구했습니다.

* 원리: 파일 시스템 전체를 스캔하여 메타데이터 구조를 교차 검증합니다.
  * 디렉터리 스캔: 모든 디렉터리를 스캔하여 각 파일이 유효한 FCB를 가리키는지 확인합니다.
  * 빈 공간 목록 검증: FCB를 스캔하여 실제로 할당된 블록과 빈 공간 목록에 표시된 빈 블록을 비교하여 일치시키고, 누락되거나 이중 할당된 블록을 복구합니다.
* 단점: 전체 파일 시스템을 스캔하는 데 매우 오랜 시간이 소요됩니다. 디스크 크기가 커질수록 복구 시간은 비례하여 증가합니다.

**3. 저널링 파일 시스템 (Journaling File Systems)**

대용량 디스크 환경에서 느린 일관성 검사를 피하기 위해 현대의 파일 시스템(NTFS, ext3, ext4)은 저널링(Journaling) 기법을 사용합니다.

* 원리: 파일 시스템의 메타데이터를 변경하기 전에, 수행할 모든 작업(트랜잭션)을 \*\*저널(Journal) 또는 로그(Log)\*\*라고 불리는 디스크의 별도 영역에 미리 기록합니다.
* 작동 단계:
  * 로깅 (Logging): 메타데이터 변경 트랜잭션을 저널에 기록합니다. (디스크에 쓰기 $$ $\text{1}$ $$)
  * 실행 (Execution): 실제 파일 시스템 구조(FCB, 디렉터리)를 변경합니다.
  * 커밋 (Commit): 모든 변경이 완료되면 저널의 해당 트랜잭션을 완료(Commit) 상태로 표시합니다.
* 충돌 발생 시 복구: 시스템 충돌 후 재부팅 시, 운영체제는 저널만 확인하여 완료되지 않은(Commit 상태가 아닌) 트랜잭션을 찾습니다.
  * 트랜잭션이 불완전하면 $$ $\rightarrow$ $$ 해당 작업을 \*\*재실행(Redo)\*\*하거나 \*\*취소(Undo)\*\*하여 일관성을 즉시 복구합니다.
* 장점: 복구 시 전체 디스크가 아닌 저널 영역만 검사하므로 복구 시간이 매우 빠릅니다 (대개 몇 초 이내).

**4. 쓰기 시 복사 (Copy-on-Write, COW)**

일부 최신 파일 시스템(예: ZFS)은 쓰기 시 복사(COW) 기법을 사용하여 데이터의 일관성을 더욱 강력하게 보장합니다.

* 원리: 데이터를 수정할 때, 기존의 데이터 블록을 덮어쓰지 않고, 새로운 데이터를 디스크의 다른 빈 공간에 씁니다. 새로운 데이터 쓰기가 완료된 후에야 메타데이터 포인터를 새로운 블록으로 변경합니다.
* 장점: 메타데이터 변경이 실패하더라도, 기존의 유효한 데이터는 그대로 남아있으므로 복구가 간단하고 데이터 손실 위험이 적습니다.
