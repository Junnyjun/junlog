# LeaderEpoch

Kafka에서 '리더 에포크(Leader Epoch)'는 파티션의 리더가 변경될 때마다 증가하는 숫자로, 리더의 변경 이력을 추적하는 데 사용됩니다. 이는 리더 교체 과정에서 데이터의 일관성을 유지하고, 복제본 간의 동기화를 관리하기 위한 중요한 개념입니다.

### 리더 에포크의 역할

1. **리더 변경 추적**: 리더 에포크는 리더가 변경될 때마다 1씩 증가합니다. 이를 통해 클러스터는 현재 리더가 어느 시점의 리더인지 확인할 수 있습니다.
2. **데이터 일관성 유지**: 리더 에포크를 사용하면, 복제본들이 서로 다른 리더를 따르지 않고, 최신 리더의 데이터를 따라갈 수 있도록 보장합니다.
3. **복제본 동기화 관리**: 팔로워 복제본은 리더 에포크를 확인하여 자신이 따라야 할 리더가 누구인지 알고, 필요한 경우 로그를 트렁케이션(truncation)하여 리더와 동일한 상태로 동기화합니다.

### 동작 원리

* **리더 변경 시 에포크 증가**: 리더 파티션에 장애가 발생하여 새로운 리더가 선출되면, 해당 파티션의 리더 에포크 값이 1 증가합니다.
* **팔로워의 에포크 확인**: 팔로워 복제본은 리더에게 Fetch 요청을 보낼 때 자신의 마지막으로 알고 있는 리더 에포크를 전달합니다.
* **에포크 불일치 처리**: 리더는 팔로워의 에포크와 자신의 에포크를 비교하여, 팔로워가 최신 리더 에포크를 알고 있는지 확인합니다. 만약 팔로워의 에포크가 낮으면, 팔로워에게 로그를 트렁케이션하도록 지시합니다.
* **로그 트렁케이션**: 팔로워는 리더와의 일관성을 유지하기 위해 자신의 로그를 리더 에포크 이후의 오프셋부터 잘라내고, 리더로부터 최신 데이터를 받아 동기화합니다.

#### 리더 에포크와 데이터 일관성

리더 에포크를 사용하면 리더 교체 과정에서 발생할 수 있는 데이터 불일치 문제를 해결할 수 있습니다. 예를 들어, 이전 리더가 장애 발생 전에 일부 메시지를 기록했지만, 그 메시지가 다른 복제본에 복제되지 않았다면, 새로운 리더는 해당 메시지를 모를 수 있습니다. 이때 리더 에포크를 통해 팔로워들이 로그를 조정하여 데이터 일관성을 유지합니다.

* **클라이언트 요청 처리**: Kafka 클라이언트는 리더 에포크를 사용하여 메시지 전송이나 소비 시 일관성을 보장할 수 있습니다.
* **장애 복구**: 리더 에포크는 장애 발생 시 복제본들이 빠르게 동기화되고, 데이터 손실을 최소화하는 데 도움이 됩니다.
* **모니터링 및 디버깅**: 운영 중인 Kafka 클러스터에서 리더 에포크 정보를 활용하여 리더 변경 이력을 추적하고, 잠재적인 문제를 진단할 수 있습니다.
