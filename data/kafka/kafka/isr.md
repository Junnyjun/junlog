# ISR

### Kafka의 복제 시스템과 ISR의 역할

Kafka는 데이터의 내구성과 가용성을 보장하기 위해 복제(replication) 메커니즘을 사용합니다. 각 토픽은 여러 개의 파티션으로 구성되며, 각 파티션은 하나의 리더(leader)와 여러 개의 팔로워(follower) 복제본을 가집니다.

* **리더**: 클라이언트의 읽기와 쓰기 요청을 처리하는 주체입니다.
* **팔로워**: 리더의 데이터를 복제하여 저장하고, 리더에 장애가 발생하면 새로운 리더로 승격될 수 있습니다.

ISR(In-Sync Replicas)은 리더와 데이터가 동기화된 상태를 유지하는 복제본들의 집합입니다. ISR은 리더와 팔로워 간의 데이터 일관성을 보장하며, 시스템의 안정성과 데이터 무결성을 유지하는 데 핵심적인 역할을 합니다.

***

### ISR의 동작 원리

**데이터 복제 과정**

* **메시지 전송**: 프로듀서가 메시지를 리더 파티션에 전송합니다.
* **로그 저장**: 리더는 메시지를 자신의 로컬 로그에 저장합니다.
* **복제 요청**: 리더는 ISR에 포함된 모든 팔로워에게 메시지를 복제하도록 요청합니다.
* **데이터 복제**: 팔로워들은 리더의 데이터를 복제하고, 완료되면 리더에게 확인 응답을 보냅니다.
* **응답 전송**: 리더는 모든 ISR 복제본이 데이터를 복제하면 프로듀서에게 메시지 전송이 성공했음을 알립니다.

**ISR의 구성과 관리**

* **동기화 유지**: 팔로워는 리더의 데이터를 지속적으로 복제하여 동기화 상태를 유지합니다.
* **ISR에서 제외**: 팔로워가 일정 시간 내에 리더의 데이터를 복제하지 못하면 ISR에서 제외됩니다.
* **재포함**: 제외된 팔로워가 다시 동기화되면 ISR에 재포함됩니다.
* **리더 장애 시 대처**: ISR에 포함된 팔로워 중 하나가 리더에 장애가 발생하면 새로운 리더로 승격됩니다.

***

### ISR과 관련된 주요 설정

**`acks` 설정**

* **`acks=all`**: 리더와 ISR에 포함된 모든 팔로워가 메시지를 복제해야 프로듀서에게 성공 응답을 보냅니다.
* **`acks=1`**: 리더가 메시지를 로그에 저장하면 즉시 프로듀서에게 성공 응답을 보냅니다.
* **`acks=0`**: 프로듀서는 리더의 응답을 기다리지 않고 메시지를 전송합니다.

**`min.insync.replicas` 설정**

* ISR에 포함되어야 하는 최소 복제본의 수를 지정합니다.
* `acks=all` 설정과 함께 사용하여 데이터의 내구성을 강화합니다.
* 예를 들어 `min.insync.replicas=2`로 설정하면, ISR에 최소 두 개의 복제본이 있어야 메시지를 성공적으로 기록합니다.

***

### ISR의 장점과 단점

**장점**

* **데이터 내구성 강화**: 리더와 동기화된 복제본을 유지하여 데이터 손실을 방지합니다.
* **고가용성 보장**: 리더 장애 시 ISR에 있는 복제본을 통해 빠르게 새로운 리더를 선출할 수 있습니다.
* **데이터 일관성 유지**: 모든 클라이언트에게 일관된 데이터를 제공합니다.

**단점**

* **성능 저하 가능성**: 모든 복제본의 확인을 기다리기 때문에 쓰기 지연이 발생할 수 있습니다.
* **리소스 소비 증가**: 복제본을 유지하기 위한 추가적인 스토리지와 네트워크 자원이 필요합니다.
* **복잡한 관리**: ISR에서 복제본이 자주 제외되고 포함되면 관리 오버헤드가 증가할 수 있습니다.

***

### ISR의 작동 예시

**정상적인 메시지 전송**

* 프로듀서가 메시지를 전송하고 `acks=all`로 설정되어 있습니다.
* 리더와 두 개의 팔로워(총 3개의 ISR 복제본)가 메시지를 복제합니다.
* 모든 복제본이 동기화되면 프로듀서는 성공 응답을 받습니다.

**팔로워 복제본의 장애**

* 한 팔로워가 네트워크 문제로 인해 리더와 동기화되지 못합니다.
* 해당 팔로워는 ISR에서 제외됩니다.
* `min.insync.replicas=2`로 설정되어 있으므로, ISR에 남은 리더와 한 개의 팔로워로 인해 프로듀서는 계속해서 메시지를 전송할 수 있습니다.
* 제외된 팔로워가 복구되어 다시 동기화되면 ISR에 재포함됩니다.

**리더의 장애**

* 리더가 장애로 인해 동작을 멈춥니다.
* ISR에 남아 있는 팔로워 중 하나가 새로운 리더로 자동 승격됩니다.
* 클라이언트는 새로운 리더를 통해 지속적으로 서비스에 접근할 수 있습니다.
* 데이터 손실 없이 서비스가 지속됩니다.

***

### ISR 설정 시 고려 사항

* **복제본 수 결정**: 시스템의 요구 사항에 맞게 복제본 수를 설정하여 데이터 내구성과 성능의 균형을 맞춰야 합니다.
* **`min.insync.replicas` 값 조정**: 데이터 손실을 방지하려면 이 값을 적절히 설정해야 하지만, 너무 높게 설정하면 일시적인 네트워크 문제에도 메시지 전송이 실패할 수 있습니다.
* **모니터링 필요성**: ISR의 상태를 지속적으로 모니터링하여 복제 지연이나 장애를 빠르게 감지하고 대응해야 합니다.
